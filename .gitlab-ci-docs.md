# GitLab CI/CD é…ç½®æ–‡æ¡£

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•ä½¿ç”¨ GitLab CI/CD è‡ªåŠ¨æ„å»ºå’Œæµ‹è¯•ç‰™é½¿åˆ†å‰²ä¸é‡å»ºç³»ç»Ÿã€‚

## ğŸ“‹ ç›®å½•

1. [CI/CD æµç¨‹æ¦‚è¿°](#cicd-æµç¨‹æ¦‚è¿°)
2. [é…ç½®è¦æ±‚](#é…ç½®è¦æ±‚)
3. [ä½¿ç”¨ Docker é•œåƒ](#ä½¿ç”¨-docker-é•œåƒ)
4. [Pipeline é˜¶æ®µè¯´æ˜](#pipeline-é˜¶æ®µè¯´æ˜)
5. [æŸ¥çœ‹æµ‹è¯•ç»“æœ](#æŸ¥çœ‹æµ‹è¯•ç»“æœ)
6. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## CI/CD æµç¨‹æ¦‚è¿°

æœ¬é¡¹ç›®çš„ CI/CD æµç¨‹åŒ…å«ä»¥ä¸‹é˜¶æ®µï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Build  â”‚ --> â”‚ Test â”‚ --> â”‚ Deploy â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æµç¨‹è¯¦ç»†è¯´æ˜

1. **Build é˜¶æ®µ**ï¼šç¼–è¯‘é¡¹ç›®ï¼ˆRelease å’Œ Debug ç‰ˆæœ¬ï¼‰
2. **Test é˜¶æ®µ**ï¼šè¿è¡Œå•å…ƒæµ‹è¯•ã€ä»£ç è´¨é‡æ£€æŸ¥ã€å†…å­˜æ£€æŸ¥
3. **Deploy é˜¶æ®µ**ï¼šç”Ÿæˆæ–‡æ¡£ï¼ˆä»… main åˆ†æ”¯ï¼‰

---

## é…ç½®è¦æ±‚

### ç³»ç»Ÿä¾èµ–

é¡¹ç›®éœ€è¦ä»¥ä¸‹ä¾èµ–ï¼š

- **ç¼–è¯‘å™¨**: GCC 7+ æˆ– Clang 6+ (æ”¯æŒ C++17)
- **CMake**: 3.16+
- **å¿…éœ€åº“**:
  - Eigen3 (3.3+)
  - PCL (Point Cloud Library 1.10+)
  - CGAL (è®¡ç®—å‡ ä½•åº“)
  - Google Test (å•å…ƒæµ‹è¯•)
  - OpenMP (å¹¶è¡Œè®¡ç®—ï¼Œå¯é€‰)
- **å¯é€‰åº“**:
  - Qt5 (GUI åŠŸèƒ½)

### GitLab Runner

éœ€è¦é…ç½® GitLab Runner å¹¶å¯ç”¨ Docker executorã€‚

---

## ä½¿ç”¨ Docker é•œåƒ

### æ–¹å¼ 1: ä½¿ç”¨é¢„æ„å»ºé•œåƒï¼ˆæ¨èï¼‰

å¦‚æœä½ çš„å›¢é˜Ÿå·²ç»æ„å»ºäº†åŒ…å«æ‰€æœ‰ä¾èµ–çš„ Docker é•œåƒï¼Œå¯ä»¥åœ¨ `.gitlab-ci.yml` ä¸­ä½¿ç”¨ï¼š

```yaml
default:
  image: your-registry/dental-segmentation-ci:latest
```

### æ–¹å¼ 2: æ„å»ºè‡ªå®šä¹‰é•œåƒ

1. **æ„å»ºé•œåƒ**ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
docker build -f Dockerfile.ci -t dental-segmentation-ci:latest .
```

2. **æ¨é€åˆ° GitLab Container Registry**ï¼š

```bash
# ç™»å½•åˆ° GitLab Container Registry
docker login registry.gitlab.com

# æ ‡è®°é•œåƒ
docker tag dental-segmentation-ci:latest registry.gitlab.com/your-group/your-project/ci:latest

# æ¨é€é•œåƒ
docker push registry.gitlab.com/your-group/your-project/ci:latest
```

3. **æ›´æ–° `.gitlab-ci.yml`**ï¼š

```yaml
default:
  image: registry.gitlab.com/your-group/your-project/ci:latest
  before_script: []  # ä¸éœ€è¦å†å®‰è£…ä¾èµ–
```

### æ–¹å¼ 3: æ¯æ¬¡å®‰è£…ä¾èµ–ï¼ˆé»˜è®¤é…ç½®ï¼‰

å½“å‰é…ç½®åœ¨æ¯æ¬¡è¿è¡Œæ—¶å®‰è£…ä¾èµ–ã€‚è¿™ç§æ–¹å¼ç®€å•ä½†è¾ƒæ…¢ã€‚

---

## Pipeline é˜¶æ®µè¯´æ˜

### 1. Build é˜¶æ®µ

#### `build:release` - æ„å»º Release ç‰ˆæœ¬

- **è§¦å‘æ¡ä»¶**: æ‰€æœ‰åˆ†æ”¯çš„æ¯æ¬¡æäº¤
- **è¯´æ˜**: æ„å»ºä¼˜åŒ–åçš„ Release ç‰ˆæœ¬ï¼Œç”¨äºæ€§èƒ½æµ‹è¯•
- **äº§ç‰©**: æ„å»ºäº§ç‰©ä¿ç•™ 1 å°æ—¶

#### `build:debug` - æ„å»º Debug ç‰ˆæœ¬

- **è§¦å‘æ¡ä»¶**: `main`ã€`develop` åˆ†æ”¯å’Œ Merge Request
- **è¯´æ˜**: æ„å»ºåŒ…å«è°ƒè¯•ä¿¡æ¯çš„ç‰ˆæœ¬ï¼Œç”¨äºè°ƒè¯•å’Œå†…å­˜æ£€æŸ¥
- **äº§ç‰©**: æ„å»ºäº§ç‰©ä¿ç•™ 1 å°æ—¶

#### `quick:check` - å¿«é€Ÿç¼–è¯‘æ£€æŸ¥

- **è§¦å‘æ¡ä»¶**: æ‰‹åŠ¨è§¦å‘ï¼ˆé™¤ `main` å’Œ `develop` å¤–çš„åˆ†æ”¯ï¼‰
- **è¯´æ˜**: å¿«é€ŸéªŒè¯ä»£ç å¯ä»¥ç¼–è¯‘ï¼Œä¸è¿è¡Œæµ‹è¯•

### 2. Test é˜¶æ®µ

#### `test:unit` - å•å…ƒæµ‹è¯•

- **è§¦å‘æ¡ä»¶**: æ‰€æœ‰åˆ†æ”¯
- **è¯´æ˜**: è¿è¡Œæ‰€æœ‰å•å…ƒæµ‹è¯•
- **è¾“å‡º**: 
  - æµ‹è¯•è¯¦ç»†æ—¥å¿—
  - JUnit XML æ ¼å¼çš„æµ‹è¯•æŠ¥å‘Š
  - ä»£ç è¦†ç›–ç‡ï¼ˆå¦‚æœé…ç½®ï¼‰

#### `test:debug` - Debug æ¨¡å¼æµ‹è¯•

- **è§¦å‘æ¡ä»¶**: `main`ã€`develop` åˆ†æ”¯å’Œ Merge Request
- **è¯´æ˜**: åœ¨ Debug æ¨¡å¼ä¸‹è¿è¡Œæµ‹è¯•ï¼Œä¾¿äºå‘ç°é—®é¢˜

#### `code:quality` - ä»£ç è´¨é‡æ£€æŸ¥

- **è§¦å‘æ¡ä»¶**: `main`ã€`develop` åˆ†æ”¯å’Œ Merge Request
- **è¯´æ˜**: ä½¿ç”¨ cppcheck è¿›è¡Œé™æ€ä»£ç åˆ†æ
- **å…è®¸å¤±è´¥**: æ˜¯ï¼ˆä¸ä¼šé˜»å¡ Pipelineï¼‰

#### `test:memory` - å†…å­˜æ³„æ¼æ£€æŸ¥

- **è§¦å‘æ¡ä»¶**: `main` åˆ†æ”¯å’Œ Merge Request
- **è¯´æ˜**: ä½¿ç”¨ Valgrind æ£€æµ‹å†…å­˜æ³„æ¼
- **å…è®¸å¤±è´¥**: æ˜¯

### 3. Deploy é˜¶æ®µ

#### `pages` - ç”Ÿæˆæ–‡æ¡£

- **è§¦å‘æ¡ä»¶**: `main` åˆ†æ”¯
- **è¯´æ˜**: ä½¿ç”¨ Doxygen ç”Ÿæˆé¡¹ç›®æ–‡æ¡£å¹¶å‘å¸ƒåˆ° GitLab Pages
- **è®¿é—®**: `https://your-group.gitlab.io/your-project/`

---

## æŸ¥çœ‹æµ‹è¯•ç»“æœ

### åœ¨ GitLab UI ä¸­æŸ¥çœ‹

1. **Pipeline æ¦‚è§ˆ**:
   - è¿›å…¥é¡¹ç›® â†’ CI/CD â†’ Pipelines
   - ç‚¹å‡»å…·ä½“çš„ Pipeline æŸ¥çœ‹å„é˜¶æ®µçŠ¶æ€

2. **æµ‹è¯•æŠ¥å‘Š**:
   - è¿›å…¥ Pipeline â†’ Tests æ ‡ç­¾
   - æŸ¥çœ‹æµ‹è¯•é€šè¿‡/å¤±è´¥è¯¦æƒ…
   - å¯ä»¥ä¸‹è½½ JUnit XML æŠ¥å‘Š

3. **æ„å»ºæ—¥å¿—**:
   - ç‚¹å‡»ä»»æ„ Job æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - å¤±è´¥çš„æµ‹è¯•ä¼šé«˜äº®æ˜¾ç¤º

4. **ä»£ç è´¨é‡æŠ¥å‘Š**:
   - åœ¨ Merge Request ä¸­ä¼šè‡ªåŠ¨æ˜¾ç¤ºä»£ç è´¨é‡å˜åŒ–

### ä½¿ç”¨å‘½ä»¤è¡ŒæŸ¥çœ‹

```bash
# æŸ¥çœ‹ Pipeline çŠ¶æ€
git log --oneline | head -5

# åœ¨æœ¬åœ°è¿è¡Œæµ‹è¯•
./build.sh
cd build
ctest --output-on-failure
```

---

## å¸¸è§é—®é¢˜

### Q1: Pipeline ä¸€ç›´å¤±è´¥ï¼Œæç¤ºæ‰¾ä¸åˆ°ä¾èµ–ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `.gitlab-ci.yml` ä¸­çš„ `before_script` æ˜¯å¦æ­£ç¡®å®‰è£…äº†æ‰€æœ‰ä¾èµ–
- æˆ–è€…ä½¿ç”¨é¢„æ„å»ºçš„ Docker é•œåƒï¼ˆæ¨èï¼‰

### Q2: æµ‹è¯•é€šè¿‡ä½† Pipeline æ˜¾ç¤ºå¤±è´¥ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥æ˜¯å¦æœ‰è­¦å‘Šè¢«å½“ä½œé”™è¯¯
- æŸ¥çœ‹å…·ä½“å¤±è´¥çš„ Job æ—¥å¿—
- å¯èƒ½æ˜¯å†…å­˜æ£€æŸ¥æˆ–ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼ˆè¿™äº›å…è®¸å¤±è´¥ï¼‰

### Q3: å¦‚ä½•åœ¨æœ¬åœ°å¤ç° CI ç¯å¢ƒï¼Ÿ

**æ–¹æ¡ˆ 1 - ä½¿ç”¨ Docker**:
```bash
# ä½¿ç”¨ CI é•œåƒè¿è¡Œå®¹å™¨
docker run -it --rm -v $(pwd):/workspace dental-segmentation-ci:latest

# åœ¨å®¹å™¨ä¸­æ„å»º
cd /workspace
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=ON
make -j$(nproc)
ctest --output-on-failure
```

**æ–¹æ¡ˆ 2 - ä½¿ç”¨æœ¬åœ°è„šæœ¬**:
```bash
# ç›´æ¥ä½¿ç”¨é¡¹ç›®çš„æ„å»ºè„šæœ¬
./build.sh
```

### Q4: å¦‚ä½•è·³è¿‡æŸä¸ª Jobï¼Ÿ

åœ¨ commit message ä¸­æ·»åŠ  `[ci skip]` æˆ– `[skip ci]`ï¼š

```bash
git commit -m "Update README [ci skip]"
```

### Q5: å¦‚ä½•åªè¿è¡Œç‰¹å®šçš„æµ‹è¯•ï¼Ÿ

åœ¨ GitLab UI ä¸­æ‰‹åŠ¨è§¦å‘ Pipeline æ—¶ï¼Œå¯ä»¥åªè¿è¡Œç‰¹å®šçš„ Jobã€‚

æˆ–è€…åœ¨æœ¬åœ°ï¼š
```bash
cd build
ctest -R test_name  # åªè¿è¡ŒåŒ¹é… test_name çš„æµ‹è¯•
```

### Q6: å¦‚ä½•åŠ é€Ÿ Pipelineï¼Ÿ

**å»ºè®®**:
1. **ä½¿ç”¨é¢„æ„å»ºçš„ Docker é•œåƒ**ï¼ˆæœ€æœ‰æ•ˆï¼‰
2. **å¯ç”¨ cache**ï¼šå·²åœ¨é…ç½®ä¸­å¯ç”¨
3. **å‡å°‘ä¸å¿…è¦çš„ Job**ï¼šä¿®æ”¹ `.gitlab-ci.yml` ä¸­çš„ `only` è§„åˆ™
4. **ä½¿ç”¨æ›´å¿«çš„ Runner**ï¼šé…ç½®æ›´å¼ºå¤§çš„æœºå™¨

### Q7: å†…å­˜æ£€æŸ¥æ€»æ˜¯è¶…æ—¶ï¼Ÿ

Valgrind ä¼šæ˜¾è‘—é™ä½è¿è¡Œé€Ÿåº¦ã€‚å¯ä»¥ï¼š
- å¢åŠ  job timeoutï¼ˆåœ¨ `.gitlab-ci.yml` ä¸­æ·»åŠ  `timeout: 2h`ï¼‰
- æˆ–è€…ç¦ç”¨å†…å­˜æ£€æŸ¥ï¼šåˆ é™¤æˆ–æ³¨é‡Š `test:memory` job

---

## è‡ªå®šä¹‰é…ç½®

### æ·»åŠ æ–°çš„æµ‹è¯•

1. åœ¨ `tests/` ç›®å½•æ·»åŠ æµ‹è¯•æ–‡ä»¶
2. æ›´æ–° `tests/CMakeLists.txt`
3. CI ä¼šè‡ªåŠ¨è¿è¡Œæ–°æµ‹è¯•

### ä¿®æ”¹æ„å»ºé€‰é¡¹

åœ¨ `.gitlab-ci.yml` çš„ `cmake` å‘½ä»¤ä¸­æ·»åŠ é€‰é¡¹ï¼š

```yaml
script:
  - cmake .. 
      -DCMAKE_BUILD_TYPE=Release
      -DBUILD_TESTING=ON
      -DYOUR_OPTION=ON
```

### æ·»åŠ ç¯å¢ƒå˜é‡

åœ¨ GitLab é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ  CI/CD å˜é‡ï¼š
- Settings â†’ CI/CD â†’ Variables
- æ·»åŠ å˜é‡ååœ¨ Pipeline ä¸­ä¼šè‡ªåŠ¨å¯ç”¨

---

## æœ€ä½³å®è·µ

1. **é¢‘ç¹æäº¤**: å°æ­¥å¿«è·‘ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
2. **å…³æ³¨æµ‹è¯•**: ç¡®ä¿æµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½
3. **æŸ¥çœ‹æŠ¥å‘Š**: å®šæœŸæŸ¥çœ‹ä»£ç è´¨é‡å’Œæµ‹è¯•æŠ¥å‘Š
4. **ä¿®å¤è­¦å‘Š**: ä¸è¦å¿½è§†ç¼–è¯‘è­¦å‘Š
5. **ä½¿ç”¨ MR**: é€šè¿‡ Merge Request è¿›è¡Œä»£ç å®¡æŸ¥

---

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- æŠ€æœ¯è´Ÿè´£äºº: [å¾…è¡¥å……]
- DevOps å›¢é˜Ÿ: [å¾…è¡¥å……]
- æäº¤ Issue: [é¡¹ç›® Issue é¡µé¢]

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-03
